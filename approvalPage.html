<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Persetujuan Laporan Stok Bibit</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif;background:#f1f5f9;color:#1e293b;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    .card{background:white;padding:40px 50px;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,0.08);max-width:600px;width:90%;text-align:center}
    h2{color:#0f172a;margin-bottom:10px}p{color:#475569;margin-bottom:20px}
    button{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;margin:10px;font-size:1rem}
    .btn-approve{background-color:#16a34a;color:white}.btn-approve:hover{background-color:#15803d}
    .btn-reject{background-color:#dc2626;color:white}.btn-reject:hover{background-color:#b91c1c}
    .status{margin-top:20px;font-weight:600}.approved{color:#16a34a}.rejected{color:#dc2626}
  </style>
</head>
<body>
  <div class="card">
    <h2>Persetujuan Laporan Stok Bibit</h2>
    <p id="infoText">Memuat data laporan...</p>

    <div id="actionButtons" style="display:none;">
      <button class="btn-approve" onclick="sendApproval('Approved')">✅ Setujui</button>
      <button class="btn-reject" onclick="sendApproval('Rejected')">❌ Tolak</button>
    </div>

    <p id="statusMsg" class="status"></p>
  </div>

  <script>
    const SHEETY_URL = "https://api.sheety.co/68250c0c0b4a18219329ec85af45d6a4/aproval/sheet1";

    const params = new URLSearchParams(window.location.search);
    const jabatan = params.get("jabatan");
    const periode = params.get("periode");

    const infoText = document.getElementById("infoText");
    const buttons = document.getElementById("actionButtons");
    const msg = document.getElementById("statusMsg");

    if (!jabatan || !periode) {
      infoText.innerHTML = "⚠️ Parameter tidak lengkap. Pastikan link berisi <b>jabatan</b> dan <b>periode</b>.";
    } else {
      infoText.innerHTML = `Dear <b>${jabatan}</b>,<br>Mohon konfirmasi laporan stok bibit periode <b>${periode}</b>.`;
      loadStatus();
    }

    async function loadStatus() {
      try {
        const res = await fetch(SHEETY_URL);
        const json = await res.json();
        const dataKey = Object.keys(json)[0]; // sheet1 / approval
        const approvals = json[dataKey] || [];
        const found = approvals.find(a => a.periode === periode && a.jabatan === jabatan);

        if (!found) {
          msg.innerHTML = "⚠️ Data belum terdaftar di Sheety.";
          return;
        }

        if (found.status === "Approved") {
          msg.innerHTML = `<span class="approved">✅ Anda sudah menyetujui laporan ini.</span>`;
        } else if (found.status === "Rejected") {
          msg.innerHTML = `<span class="rejected">❌ Anda telah menolak laporan ini.</span>`;
        } else {
          msg.innerHTML = "⏳ Status Anda: <b>Pending</b>";
          buttons.style.display = "block";
        }
      } catch (err) {
        msg.innerHTML = "❌ Gagal memuat data: " + err.message;
      }
    }

    async function sendApproval(status) {
      msg.innerHTML = "⏳ Menyimpan keputusan...";
      try {
        const res = await fetch(SHEETY_URL);
        const json = await res.json();
        const dataKey = Object.keys(json)[0];
        const approvals = json[dataKey] || [];
        const found = approvals.find(a => a.periode === periode && a.jabatan === jabatan);
        const waktu = new Date().toISOString();

        if (!found) {
          // fallback POST kalau ID tidak ditemukan
          const newBody = {
            [dataKey]: {
              periode: periode,
              jabatan: jabatan,
              status: status,
              waktu: waktu
            }
          };
          await fetch(SHEETY_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newBody)
          });
          msg.innerHTML = "✅ Data baru disimpan (fallback POST).";
          buttons.style.display = "none";
          return;
        }

        // PUT update baris yang ditemukan
        const id = found.id;
        const updateUrl = `${SHEETY_URL}/${id}`;
        const body = {
          [dataKey]: { status: status, waktu: waktu }
        };

        const putRes = await fetch(updateUrl, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (putRes.ok) {
          msg.innerHTML = status === "Approved"
            ? `<span class="approved">✅ Terima kasih, Anda telah menyetujui laporan ini.</span>`
            : `<span class="rejected">❌ Anda telah menolak laporan ini.</span>`;
          buttons.style.display = "none";
        } else {
          msg.innerHTML = "❌ Gagal menyimpan data ke Sheety.";
        }
      } catch (err) {
        msg.innerHTML = "❌ Terjadi kesalahan: " + err.message;
      }
    }
  </script>
</body>
</html>
