<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Persetujuan Laporan Stok Bibit</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ... (CSS tidak berubah, bisa disalin dari kode sebelumnya) ... */
    body { font-family: 'Inter', sans-serif; background: #f1f5f9; color: #1e293b; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; } .card { background: white; padding: 40px 50px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 600px; width: 100%; text-align: center; } h2 { color: #0f172a; margin-bottom: 10px; } p { color: #475569; margin-bottom: 25px; line-height: 1.6; } button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 10px; font-size: 1rem; transition: background-color 0.2s; -webkit-tap-highlight-color: transparent; } button:disabled { cursor: not-allowed; opacity: 0.6; } .btn-approve { background-color: #16a34a; color: white; } .btn-approve:hover:not(:disabled) { background-color: #15803d; } .btn-reject { background-color: #dc2626; color: white; } .btn-reject:hover:not(:disabled) { background-color: #b91c1c; } .status { margin-top: 20px; font-weight: 600; padding: 12px; border-radius: 8px; } .approved { color: #16a34a; background-color: #dcfce7; } .rejected { color: #dc2626; background-color: #fee2e2; } .pending { color: #ca8a04; background-color: #fef9c3; } .error { color: #b91c1c; background-color: #fee2e2; } .footer { margin-top: 30px; font-size: 0.85rem; color: #94a3b8; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Persetujuan Laporan Stok Bibit Nursery</h2>
    <p id="infoText">Memvalidasi link...</p>

    <div id="actionButtons" style="display:none;">
      <button id="btnApprove" class="btn-approve" onclick="sendApproval('Approved')">‚úÖ Setujui</button>
      <button id="btnReject" class="btn-reject" onclick="sendApproval('Rejected')">‚ùå Tolak</button>
    </div>

    <p id="statusMsg" class="status"></p>

    <div class="footer">
      ¬© 2025 PT Energi Batubara Lestari<br>
      Sistem Laporan Persemaian
    </div>
  </div>

  <script>
    // üü¢ Ganti URL API Sheety dan Nama Sheet Anda
    const SHEETY_API_URL = "https://api.sheety.co/68250c0c0b4a18219329ec85af45d6a4/aproval/sheet1";
    const SHEET_NAME = "sheet1"; 

    const infoText = document.getElementById("infoText");
    const actionButtons = document.getElementById("actionButtons");
    const statusMsg = document.getElementById("statusMsg");
    const btnApprove = document.getElementById("btnApprove");
    const btnReject = document.getElementById("btnReject");

    const params = new URLSearchParams(window.location.search);
    const jabatan = params.get("jabatan");
    const periode = params.get("periode");

    let targetRowId = null; 

    async function main() {
      if (!jabatan || !periode) {
        showStatus("‚ö†Ô∏è Parameter tidak lengkap. Pastikan link berisi <b>jabatan</b> dan <b>periode</b>.", "error");
        infoText.style.display = 'none';
        return;
      }
      await loadStatus();
    }

    function showStatus(message, type) {
        statusMsg.innerHTML = message;
        statusMsg.className = `status ${type}`; 
    }

    async function loadStatus() {
      showStatus("‚è≥ Memuat status terkini...", "pending");
      try {
        const response = await fetch(SHEETY_API_URL);
        if (!response.ok) throw new Error(`Gagal mengambil data (HTTP ${response.status})`);
        
        const json = await response.json();
        const data = json[SHEET_NAME] || [];
        const currentRow = data.find(row => row.periode === periode && row.jabatan === jabatan);

        if (!currentRow) {
          infoText.style.display = 'none';
          showStatus("‚ö†Ô∏è Data untuk periode dan jabatan ini tidak ditemukan. Hubungi admin.", "error");
          return;
        }
        
        targetRowId = currentRow.id; 
        const namaApprover = currentRow.nama; // <-- MENGAMBIL NAMA DARI SHEET

        // Menampilkan nama di teks sapaan
        infoText.innerHTML = `
          Dear <b>${namaApprover}</b> (${jabatan}),<br>
          Mohon konfirmasi atas laporan stok bibit periode <b>${periode}</b>.<br>
          Silakan pilih salah satu tindakan di bawah ini:
        `;

        const currentStatus = currentRow.status ? currentRow.status.trim() : "Pending";

        if (currentStatus === "Approved") {
          showStatus(`‚úÖ Anda sudah menyetujui laporan ini.`, "approved");
        } else if (currentStatus === "Rejected") {
          showStatus(`‚ùå Anda telah menolak laporan ini.`, "rejected");
        } else {
          showStatus("ü§î Menunggu keputusan Anda.", "pending");
          actionButtons.style.display = "block"; 
        }
      } catch (err) {
        infoText.style.display = 'none';
        showStatus(`‚ùå Gagal memuat data: ${err.message}`, "error");
      }
    }

    async function sendApproval(status) {
      if (!targetRowId) {
          showStatus("‚ùå ID baris tidak ditemukan. Tidak dapat melanjutkan.", "error");
          return;
      }

      btnApprove.disabled = true;
      btnReject.disabled = true;
      showStatus("‚è≥ Menyimpan keputusan Anda...", "pending");

      const updateUrl = `${SHEETY_API_URL}/${targetRowId}`;
      const timestamp = new Date().toLocaleString("id-ID", { timeZone: "Asia/Jakarta" });

      const body = {
        [SHEET_NAME]: {
          status: status,
          waktu: timestamp
        }
      };

      try {
        const response = await fetch(updateUrl, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.errors[0]?.detail || `Gagal menyimpan (HTTP ${response.status})`);
        }

        actionButtons.style.display = "none";
        if (status === "Approved") {
          showStatus("‚úÖ Terima kasih! Laporan telah Anda SETUJUI.", "approved");
        } else {
          showStatus("‚ùå Laporan telah Anda TOLAK.", "rejected");
        }
      } catch (err) {
        showStatus(`‚ùå Terjadi kesalahan: ${err.message}`, "error");
        btnApprove.disabled = false;
        btnReject.disabled = false;
      }
    }

    main();
  </script>
</body>
</html>
